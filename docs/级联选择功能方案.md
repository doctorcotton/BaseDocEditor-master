# 级联选择功能方案

## 📋 需求背景

### 问题描述
在"原料标准明细"表的编辑界面中，"检测方法"字段的候选选项应该根据当前记录的"检测项目"动态变化，而不是显示所有可用的检测方法。

### 当前状态
- 目前"检测方法"字段显示所有选项，未根据"检测项目"进行筛选
- 用户需要从大量不相关的选项中查找，体验不佳
- 容易选择错误的检测方法

### 期望效果
- 当用户编辑某条记录的"检测方法"时，只显示与该记录"检测项目"相关的方法
- 例如：当检测项目为"叶底"时，只显示叶底相关的检测方法

---

## 📊 数据结构分析

### 涉及的表格

#### 1. 原料标准明细表（主表）
编辑界面中显示的表格，包含以下关键字段：

| 字段名 | 字段ID | 类型 | 说明 |
|--------|--------|------|------|
| 检测项目 | `fldPVBJ4xJ` | 单选/文本 | 当前记录的检测项目（如：叶底、外形、其他） |
| 检测方法 | `fldeffP9dE` | 单选 | 需要级联筛选的字段 |

#### 2. 检测方法库表（引用表）
存储检测项目与检测方法对应关系的表格：

| 字段名 | 字段ID | 类型 | 说明 |
|--------|--------|------|------|
| 标准项目（选项） | 待确认 | 单选 | 检测项目分类 |
| 标准检测方法 | 待确认 | 文本 | 检测方法的详细描述 |
| 标准检测方法（选项） | 待确认 | 单选 | 检测方法的选项值 |

### 数据示例

根据截图，引用表中的对应关系如下：

| 标准项目 | 标准检测方法（选项） |
|----------|---------------------|
| 其他 | GB/T 19630 |
| 内源性异物(黑点) | GB/T 31121 |
| 叶底 | 参考GB/T 23776，取茶样3.0g或5.0g... |
| 叶底 | GB/T 23776 |
| 叶底 | 参考GB/T 23776 分别取茶样和标样3.0g或5.0g... |
| 外形 | 参考GB/T 23776，取茶样3.0g或5.0g... |
| 外形 | GB/T 23776 |
| ... | ... |

---

## 🔧 技术方案

### 方案概述

1. **加载引用表数据**：在组件初始化时，加载"检测方法库"表的所有记录
2. **建立映射关系**：根据"标准项目"字段，建立 `检测项目 -> 检测方法列表` 的映射
3. **动态筛选**：编辑"检测方法"时，根据当前记录的"检测项目"值筛选可用选项

### 实现位置

主要修改文件：`src/components/TemplateRenderer/LoopTableRenderer.tsx`

### 配置结构

```typescript
/**
 * 级联选项筛选配置
 */
interface OptionFilterConfig {
  targetFieldId: string;      // 被筛选的字段ID（检测方法）
  sourceFieldId: string;      // 筛选依据字段ID（检测项目）
  linkedTableId?: string;     // 引用表ID（检测方法库表）
  filterFieldId?: string;     // 引用表中的筛选字段ID（标准项目）
  optionFieldId?: string;     // 引用表中的选项字段ID（标准检测方法选项）
}

// 配置示例
const OPTION_FILTER_CONFIGS: OptionFilterConfig[] = [
  {
    targetFieldId: 'fldeffP9dE',      // 检测方法
    sourceFieldId: 'fldPVBJ4xJ',      // 检测项目
    linkedTableId: 'tblXXXXXX',       // 检测方法库表ID（待填入）
    filterFieldId: 'fldYYYYYY',       // 标准项目字段ID（待填入）
    optionFieldId: 'fldZZZZZZ',       // 标准检测方法选项字段ID（待填入）
  }
];
```

### 核心逻辑

```typescript
/**
 * 根据检测项目值获取可用的检测方法选项
 */
const getFilteredOptions = (recordId: string, targetFieldId: string, allOptions: any[]): any[] => {
  // 1. 查找级联配置
  const filterConfig = optionFilterConfigs.find(c => c.targetFieldId === targetFieldId);
  if (!filterConfig) {
    return allOptions; // 没有配置，返回所有选项
  }

  // 2. 获取当前记录的检测项目值
  const sourceValue = getFieldValue(recordId, filterConfig.sourceFieldId);
  if (!sourceValue) {
    return allOptions; // 没有检测项目值，返回所有选项
  }

  // 3. 从引用表数据中筛选匹配的检测方法
  const sourceName = extractText(sourceValue); // 如 "叶底"
  
  const matchedRecords = linkedTableData.records.filter(record => {
    const projectValue = record.fields[filterConfig.filterFieldId];
    return extractText(projectValue) === sourceName;
  });

  // 4. 提取检测方法选项
  return matchedRecords.map(record => {
    const optionValue = record.fields[filterConfig.optionFieldId];
    return {
      id: optionValue?.id || record.recordId,
      name: extractText(optionValue),
      text: extractText(optionValue)
    };
  });
};
```

### 数据流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                        组件初始化                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. 加载引用表（检测方法库）数据                                  │
│     - 获取所有记录                                               │
│     - 缓存到 linkedTableData                                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 建立映射关系                                                 │
│     {                                                           │
│       "叶底": ["GB/T 23776", "参考GB/T 23776...", ...],         │
│       "外形": ["GB/T 23776", "参考GB/T 23776...", ...],         │
│       "其他": ["GB/T 19630"],                                   │
│       ...                                                       │
│     }                                                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 用户双击编辑"检测方法"单元格                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. 获取当前记录的"检测项目"值（如："叶底"）                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. 从映射中查找对应的检测方法列表                                │
│     ["GB/T 23776", "参考GB/T 23776...", ...]                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. 渲染筛选后的选项下拉列表                                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📝 待完成事项

### 需要确认的信息

| 项目 | 说明 | 状态 |
|------|------|------|
| 检测方法库表 table_id | 引用表的唯一标识 | ⏳ 待确认 |
| 标准项目字段 field_id | 引用表中"标准项目（选项）"字段的ID | ⏳ 待确认 |
| 标准检测方法选项字段 field_id | 引用表中"标准检测方法（选项）"字段的ID | ⏳ 待确认 |
| 关联字段稳定性 | 当前关联字段还不稳定，需等待稳定后再实现 | ⏳ 待稳定 |

### 获取字段ID的方法

1. **通过 URL 获取 table_id**：
   - 打开检测方法库表
   - URL 中 `tbl` 开头的部分即为 table_id
   - 例如：`https://xxx.feishu.cn/base/xxx?table=tblABCDEF` 中的 `tblABCDEF`

2. **通过控制台获取 field_id**：
   - 运行应用，打开浏览器开发者工具（F12）
   - 查看控制台日志中的字段信息输出
   - 或调用 `table.getFieldMetaList()` 获取所有字段

3. **通过飞书 API 获取**：
   ```bash
   curl -X GET \
     'https://open.feishu.cn/open-apis/bitable/v1/apps/{app_token}/tables/{table_id}/fields' \
     -H 'Authorization: Bearer {access_token}'
   ```

---

## 🚀 实现步骤

### 阶段一：准备工作（当前已完成）

- [x] 分析需求和数据结构
- [x] 设计技术方案
- [x] 在 `LoopTableRenderer.tsx` 中添加基础框架代码
- [x] 添加调试日志输出
- [x] 编写文档

### 阶段二：配置与实现（待关联字段稳定后）

- [ ] 确认引用表的 table_id
- [ ] 确认引用表中相关字段的 field_id
- [ ] 更新 `OPTION_FILTER_CONFIGS` 配置
- [ ] 完善 `getFilteredOptions` 筛选逻辑
- [ ] 处理边界情况（无匹配项、空值等）

### 阶段三：测试与优化

- [ ] 测试级联选择功能
- [ ] 优化加载性能（缓存引用表数据）
- [ ] 处理异常情况
- [ ] 用户体验优化

---

## 📌 注意事项

1. **性能考虑**：引用表数据应该缓存，避免每次编辑都重新加载
2. **数据一致性**：如果引用表数据更新，需要有机制刷新缓存
3. **空值处理**：当检测项目为空时，可以显示所有选项或提示用户先选择检测项目
4. **错误处理**：引用表加载失败时，应该回退到显示所有选项

---

## 📅 更新记录

| 日期 | 内容 | 作者 |
|------|------|------|
| 2025-11-25 | 创建文档，记录需求和技术方案 | AI Assistant |


