# PDF 导出功能使用说明

## 概述

项目已升级为使用 `@react-pdf/renderer` 生成真正的文本 PDF（而非图片截图），支持中文显示、超链接、图片等完整功能。

## 主要改进

### 之前（图片方式）
- ❌ 使用 html2canvas + jsPDF 将页面截图转为 PDF
- ❌ 生成的是图片，文件较大
- ❌ 文字无法复制和搜索
- ❌ 打印质量差

### 现在（文本方式）
- ✅ 使用 React-PDF 直接生成文本 PDF
- ✅ 文件更小，质量更高
- ✅ 支持文字选择、复制、搜索
- ✅ 支持超链接点击
- ✅ 打印质量好

## 功能特性

### 1. 中文支持
使用 **Noto Sans SC**（思源黑体简体）字体，完美显示中文字符。

### 2. 富文本超链接
自动识别以下格式的超链接：
- 飞书文档链接：`{type: 'url', link: '...', text: '...'}`
- 普通URL：`http://...` 或 `https://...`
- 链接自动转为可点击的蓝色下划线样式

### 3. 图片支持
从附件字段加载图片，支持：
- 单个或多个图片
- 自动适应页面宽度
- 保持图片比例

### 4. 复杂表格
支持三种表格类型：
- **静态表格**：使用配置的固定行
- **动态表格**：从当前记录字段读取
- **循环表格**：从关联记录列表生成

### 5. 循环区域
支持渲染关联记录列表，包括：
- 筛选条件
- 嵌套表格
- 多条记录自动排列

## 使用方法

### 导出 PDF

1. 在模板编辑页面，切换到"预览"模式
2. 点击右上角的"导出/上传 PDF"按钮
3. 选择导出方式：
   - **仅下载**：PDF 文件下载到本地
   - **上传到附件字段**：选择一个附件字段，PDF 将自动上传

### 文件命名规则

PDF 文件名自动生成，格式为：
```
{标准名称} 原料品质标准-{版本号}.pdf
```

例如：`白砂糖 原料品质标准-V1.0.pdf`

## 样式说明

### 页面设置
- **纸张大小**：A4 (210mm × 297mm)
- **页边距**：上下 17mm，左右 12mm
- **字体大小**：默认 10pt

### 表格样式
- 表头：灰色背景，居中对齐，粗体
- 第一列：左对齐（通常是"项目"列）
- 其他列：居中对齐
- 边框：黑色实线，1px

### 超链接样式
- 颜色：蓝色 (#0066cc)
- 装饰：下划线
- 可点击

## 特殊字段处理

### 1. 标题字段（id='title'）
自动拼接版本号，格式为：
```
{标准名称} 原料品质标准-{版本号}
```

### 2. 致敏物质信息字段（fldNL9B304）
- 为空时显示"无"而非"空"
- 不显示字段名称标签

### 3. 打印时间戳
PDF 右下角显示打印时间，格式：
```
打印时间：2024-11-25 19:30:00
```

## 常见问题

### Q: 为什么有些图片无法显示？
**A**: 可能的原因：
1. 图片 URL 已过期（飞书临时链接有效期限制）
2. 跨域问题（需要 CORS 支持）
3. 图片格式不支持

**解决方法**：
- 使用飞书永久链接
- 将图片上传到支持 CORS 的服务器

### Q: 中文显示为方框？
**A**: 字体未正确加载。检查：
1. `/public/fonts/` 目录是否有字体文件
2. 字体文件名是否正确（NotoSansSC-Regular.otf）
3. 浏览器控制台是否有字体加载错误

### Q: PDF 文件很大？
**A**: 可能原因：
1. 包含大量高分辨率图片
2. 中文字体文件被嵌入（Noto Sans SC 约 16MB）

**优化建议**：
- 压缩图片
- 使用子集字体（仅包含需要的字符）

### Q: 表格被截断？
**A**: React-PDF 会自动分页，但不像图片方式那样精确控制。建议：
- 减少单页内容量
- 使用更小的字体
- 调整表格列宽

### Q: 超链接无法点击？
**A**: 检查：
1. URL 格式是否正确（必须以 http:// 或 https:// 开头）
2. 使用 PDF 阅读器打开（部分浏览器预览不支持点击）

## 开发者说明

### 文件结构
```
src/
├── components/PdfExport/     # PDF 组件库
│   ├── PdfDocument.tsx       # 主入口
│   ├── PdfTextElement.tsx    # 文本
│   ├── PdfFieldElement.tsx   # 字段
│   ├── PdfTableElement.tsx   # 表格
│   ├── PdfLoopArea.tsx       # 循环区域
│   ├── PdfImageElement.tsx   # 图片
│   ├── PdfLinkElement.tsx    # 链接
│   ├── PdfRichText.tsx       # 富文本
│   └── pdfStyles.ts          # 样式
├── utils/
│   ├── pdfDataMapper.ts      # 数据映射
│   └── pdfFonts.ts           # 字体注册
└── public/fonts/             # 字体文件
```

### 添加新字段类型

1. 在 `pdfDataMapper.ts` 中添加解析逻辑
2. 在对应的 PDF 组件中添加渲染逻辑
3. 在 `pdfStyles.ts` 中添加样式

### 调试技巧

1. **查看生成的 PDF 结构**：
   ```typescript
   console.log(await pdf(<PdfDocument {...props} />).toString());
   ```

2. **检查数据映射**：
   ```typescript
   const segments = parseRichText(value, fieldType);
   console.log('Rich text segments:', segments);
   ```

3. **验证字体加载**：
   打开浏览器控制台，查看是否有字体加载错误

## 性能优化建议

1. **预加载循环数据**：已在 `PdfDocument` 中实现
2. **懒加载图片**：使用 URL 引用而非 base64
3. **缓存字体文件**：浏览器会自动缓存字体
4. **减少嵌套层级**：简化模板结构

## 未来计划

- [ ] 支持页眉页脚
- [ ] 支持水印
- [ ] 支持自定义字体
- [ ] 支持更多字段类型
- [ ] 优化大数据量场景
- [ ] 添加导出进度提示

