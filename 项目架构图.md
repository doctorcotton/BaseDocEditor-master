# BaseDocEditor 项目架构图

## 📦 项目结构

```
BaseDocEditor/
├── src/
│   ├── App.tsx                      # 主应用入口
│   ├── App.css                      # 主应用样式
│   ├── index.tsx                    # React 入口
│   │
│   ├── components/                  # UI 组件
│   │   ├── DocumentRenderer.tsx     # 文档渲染组件
│   │   ├── DocumentRenderer.css
│   │   ├── FieldRenderer.tsx        # 字段渲染器
│   │   ├── FieldRenderer.css
│   │   ├── FieldEditor.tsx          # 字段编辑器
│   │   ├── SyncPanel.tsx            # 同步面板
│   │   ├── SyncPanel.css
│   │   └── LoadApp/                 # SDK 加载组件
│   │
│   ├── hooks/                       # 业务逻辑 Hooks
│   │   ├── useTableData.ts          # 表格数据管理
│   │   ├── useChangeTracking.ts     # 修改追踪
│   │   └── useDocumentSync.ts       # 同步管理
│   │
│   ├── utils/                       # 工具函数
│   │   ├── fieldFormatter.ts        # 字段格式化
│   │   └── draftStorage.ts          # 草稿存储
│   │
│   ├── types/                       # TypeScript 类型
│   │   └── index.ts
│   │
│   └── locales/                     # 国际化
│       ├── i18n.ts
│       ├── zh.json
│       └── en.json
│
├── docs/                            # 项目文档
│   ├── 需求分析.md
│   ├── 技术方案.md
│   ├── 开发计划.md
│   └── API文档.md
│
├── public/                          # 静态资源
├── dist/                            # 构建产物
├── package.json                     # 项目配置
├── tsconfig.json                    # TypeScript 配置
├── vite.config.js                   # Vite 配置
├── README.md                        # 项目说明
├── 快速启动指南.md                   # 使用指南
├── 项目架构图.md                     # 本文件
└── .gitignore                       # Git 忽略配置
```

## 🏗️ 技术架构

### 三层架构

```
┌─────────────────────────────────────────────────┐
│              飞书多维表格 API                    │
│         (数据源 & 数据目标)                      │
└────────────────┬────────────────────────────────┘
                 │ @lark-base-open/js-sdk
                 ↓
┌─────────────────────────────────────────────────┐
│           数据管理层 (Data Layer)                │
│  ┌─────────────────────────────────────────┐   │
│  │  useTableData                           │   │
│  │  • 读取表格列表                         │   │
│  │  • 读取记录和字段                       │   │
│  │  • 刷新数据                             │   │
│  └─────────────────────────────────────────┘   │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│         业务逻辑层 (Business Layer)              │
│  ┌──────────────────┐  ┌──────────────────┐   │
│  │ useChangeTracking│  │ useDocumentSync  │   │
│  │ • 追踪字段修改   │  │ • 批量同步修改   │   │
│  │ • 记录原值新值   │  │ • 错误处理       │   │
│  │ • 草稿自动保存   │  │ • 结果反馈       │   │
│  └──────────────────┘  └──────────────────┘   │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│            UI 展示层 (UI Layer)                  │
│  ┌──────────────────────────────────────────┐  │
│  │  App.tsx (主应用)                        │  │
│  │  ├─ 表格选择器                           │  │
│  │  ├─ DocumentRenderer (文档渲染)         │  │
│  │  │   └─ FieldRenderer (字段渲染)        │  │
│  │  │       └─ FieldEditor (字段编辑)      │  │
│  │  └─ SyncPanel (同步面板)                │  │
│  └──────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│            本地存储 (LocalStorage)               │
│  • 草稿数据 (7天有效期)                          │
└─────────────────────────────────────────────────┘
```

## 🔄 数据流

### 读取流程

```
用户选择表格
    ↓
useTableData.selectTable()
    ↓
加载字段元数据 (getFieldMetaList)
    ↓
加载记录列表 (getRecordIdList + getRecordsByIds)
    ↓
DocumentRenderer 渲染
    ↓
用户查看文档
```

### 编辑流程

```
用户点击字段
    ↓
FieldRenderer 进入编辑模式
    ↓
FieldEditor 显示对应编辑器
    ↓
用户修改并保存
    ↓
useChangeTracking.trackChange()
    ↓
高亮显示 + 保存草稿
    ↓
SyncPanel 显示修改
```

### 同步流程

```
用户点击"同步到表格"
    ↓
显示确认对话框
    ↓
useDocumentSync.syncChanges()
    ↓
按记录分组修改
    ↓
批量调用 table.setRecords()
    ↓
标记为已同步 + 清除草稿
    ↓
显示同步结果 + 重新加载数据
```

## 🧩 核心组件说明

### App.tsx
- **职责**: 主应用容器，协调各个模块
- **状态管理**: 整合所有 Hooks
- **布局**: Header + Content + Footer

### DocumentRenderer
- **职责**: 渲染记录列表
- **特点**: 卡片式布局，响应式设计
- **子组件**: FieldRenderer

### FieldRenderer
- **职责**: 渲染单个字段
- **功能**: 显示/编辑模式切换，高亮修改
- **子组件**: FieldEditor

### FieldEditor
- **职责**: 根据字段类型提供编辑器
- **支持**: Text, Number, DateTime, Select, Checkbox
- **交互**: Enter 保存，Esc 取消

### SyncPanel
- **职责**: 显示待同步的修改列表
- **功能**: 修改对比，单个撤销，批量同步
- **反馈**: 同步成功/失败提示

## 🔧 核心 Hooks

### useTableData
```typescript
{
  tables: TableInfo[];          // 表格列表
  currentTable: ITable | null;  // 当前表格
  records: IRecord[];           // 记录列表
  fields: IFieldMeta[];         // 字段元数据
  loading: boolean;             // 加载状态
  error: string | null;         // 错误信息
  selectTable: (id) => void;    // 选择表格
  reload: () => void;           // 重新加载
}
```

### useChangeTracking
```typescript
{
  changes: Map<string, FieldChange>;  // 修改映射
  trackChange: (...) => void;         // 记录修改
  undoChange: (key) => void;          // 撤销修改
  clearChanges: () => void;           // 清空修改
  getPendingChanges: () => [];        // 待同步列表
  markAsSynced: (key) => void;        // 标记已同步
  changeCount: number;                // 修改数量
}
```

### useDocumentSync
```typescript
{
  syncing: boolean;               // 同步中
  syncResult: SyncResult | null;  // 同步结果
  syncChanges: (...) => boolean;  // 同步修改
  clearSyncResult: () => void;    // 清除结果
}
```

## 📊 状态管理

使用 **React Hooks + Context** 模式：

```typescript
App (状态容器)
  ├─ useTableData      // 表格数据
  ├─ useChangeTracking // 修改追踪
  └─ useDocumentSync   // 同步管理
```

## 🎨 样式方案

- **UI 框架**: Semi Design (@douyinfe/semi-ui)
- **样式**: CSS Modules
- **主题**: 支持深色/浅色模式（Semi Design 自带）
- **响应式**: Flexbox + Grid

## 🔐 安全考虑

1. **权限控制**: 使用飞书 SDK 的权限系统
2. **数据隔离**: 只能访问有权限的表格
3. **本地存储**: 草稿数据仅存本地
4. **类型安全**: 全程 TypeScript

## ⚡ 性能优化

1. **批量操作**: 使用 `setRecords` 批量更新
2. **懒加载**: 按需加载记录（分批100条）
3. **防抖**: 编辑器输入防抖（500ms）
4. **缓存**: 字段元数据缓存

## 🚀 未来规划

### Phase 2 功能
- 评论系统
- 修改历史
- 自定义模板

### Phase 3 功能
- 多人协作
- 冲突检测
- 云端同步

---

**版本**: v1.0.0  
**最后更新**: 2025-11-23
